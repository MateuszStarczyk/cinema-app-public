DROP ALL OBJECTS;

DROP TABLE IF EXISTS TICKET_MANAGED_TICKETS;
DROP TABLE IF EXISTS MANAGED_TICKETS;
DROP TABLE IF EXISTS SEATS;
DROP TABLE IF EXISTS TICKETS;
DROP TABLE IF EXISTS SCREENINGS;
DROP TABLE IF EXISTS MOVIES;
DROP TABLE IF EXISTS SEATS_ROWS;
DROP TABLE IF EXISTS ROOMS;
DROP TABLE IF EXISTS USER_ROLES;
DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS ROLES;

CREATE TABLE USERS (
   ID BIGINT PRIMARY KEY AUTO_INCREMENT,
   EMAIL varchar(50) NOT NULL,
   PASSWORD varchar(120) NOT NULL,
   FIRST_NAME varchar(50) NOT NULL,
   LAST_NAME varchar(50) NOT NULL
);

CREATE TABLE ROLES (
   ID INTEGER PRIMARY KEY AUTO_INCREMENT,
   NAME varchar(20) NOT NULL
);

CREATE TABLE USER_ROLES (
   USER_ID BIGINT NOT NULL,
   ROLE_ID INTEGER NOT NULL,
   CONSTRAINT PK_USER_ROLES PRIMARY KEY (USER_ID, ROLE_ID),
   CONSTRAINT FK_USER_ID FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
   CONSTRAINT FK_ROLE_ID FOREIGN KEY (ROLE_ID) REFERENCES ROLES(ID)
);

CREATE TABLE MANAGED_TICKETS (
    ID INTEGER PRIMARY KEY AUTO_INCREMENT,
    NAME varchar(20) NOT NULL,
    PRICE DOUBLE NOT NULL,
    IS_ACTIVE BIT NOT NULL
);

CREATE TABLE MOVIES (
    ID UUID DEFAULT RANDOM_UUID() PRIMARY KEY,
    TITLE varchar(20) NOT NULL,
    DURATION NUMBER NOT NULL,
    POSTER_FILENAME VARCHAR,
    TRAILER_URL VARCHAR,
    DESCRIPTION VARCHAR
);

CREATE TABLE ROOMS (
    ID INTEGER PRIMARY KEY AUTO_INCREMENT,
    SEATS INTEGER NOT NULL
);

CREATE TABLE SEATS_ROWS (
    SYMBOL VARCHAR(2),
    NUMBER_OF_SEATS INTEGER NOT NULL,
    ROOM_ID NUMBER NOT NULL,
    CONSTRAINT PK_SEATS_ROWS PRIMARY KEY (SYMBOL, ROOM_ID),
    CONSTRAINT SEATS_ROWS_FK_ROOM_ID FOREIGN KEY (ROOM_ID) REFERENCES ROOMS(ID)
);

CREATE TABLE SCREENINGS (
    ID INTEGER PRIMARY KEY AUTO_INCREMENT,
    SCREENING_START_DATE DATETIME NOT NULL,
    SCREENING_END_DATE DATETIME NOT NULL,
    ROOM_ID NUMBER NOT NULL,
    MOVIE_ID UUID NOT NULL,
    CONSTRAINT SCREENINGS_FK_MOVIE_ID FOREIGN KEY (MOVIE_ID) REFERENCES MOVIES(ID),
    CONSTRAINT SCREENINGS_FK_ROOM_ID FOREIGN KEY (ROOM_ID) REFERENCES ROOMS(ID)
);

CREATE TABLE TICKETS (
    ID UUID DEFAULT RANDOM_UUID() PRIMARY KEY,
    SCREENING_ID INTEGER NOT NULL,
    USER_ID BIGINT NOT NULL,
    CONSTRAINT TICKET_FK_SCREENING_ID FOREIGN KEY (SCREENING_ID) REFERENCES SCREENINGS(ID),
    CONSTRAINT TICKET_FK_USER_ID FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);

CREATE TABLE SEATS (
    ID INTEGER PRIMARY KEY AUTO_INCREMENT,
    SEAT_NUMBER VARCHAR(5),
    TICKET_ID UUID NOT NULL,
    CONSTRAINT SEATS_FK_TICKET_ID FOREIGN KEY (TICKET_ID) REFERENCES TICKETS(ID)
);

CREATE TABLE TICKET_MANAGED_TICKETS (
    TICKET_ID UUID NOT NULL,
    TICKET_TYPE_ID INTEGER NOT NULL,
    QUANTITY INTEGER,
    CONSTRAINT PK_TICKET_MANAGED_TICKETS PRIMARY KEY (TICKET_ID, TICKET_TYPE_ID),
    CONSTRAINT TICKET_MANAGED_TICKETS_FK_TICKET_ID FOREIGN KEY (TICKET_ID) REFERENCES TICKETS(ID),
    CONSTRAINT TICKET_MANAGED_TICKETS_FK_TICKET_TYPE_ID FOREIGN KEY (TICKET_TYPE_ID) REFERENCES MANAGED_TICKETS(ID)
);

INSERT INTO ROLES(NAME) VALUES('ROLE_USER');
INSERT INTO ROLES(NAME) VALUES('ROLE_ADMIN');

--has≈Ço 123456
INSERT INTO USERS VALUES (1, 'mr@cinema.pl', '$2a$10$xdAvDiDuAv7IZpId6wXpwOGdWMGe9SCmQOhSnkm20iFeF9xa7WafC', 'Mateusz', 'Rokosa');
INSERT INTO USERS VALUES (2, 'tt@testing.com', '$2a$10$xdAvDiDuAv7IZpId6wXpwOGdWMGe9SCmQOhSnkm20iFeF9xa7WafC', 'Testing', 'Tester');
INSERT INTO USERS VALUES (3, 'admin@testing.com', '$2a$10$xdAvDiDuAv7IZpId6wXpwOGdWMGe9SCmQOhSnkm20iFeF9xa7WafC', 'Testing', 'Admin');

INSERT INTO USER_ROLES VALUES (1, 1);
INSERT INTO USER_ROLES VALUES (2, 1);
INSERT INTO USER_ROLES VALUES (3, 2);

INSERT INTO MANAGED_TICKETS VALUES (1, 'CHILD / STUDENT', 15.99, 1);
INSERT INTO MANAGED_TICKETS VALUES (2, 'ADULT', 22, 1);

INSERT INTO MOVIES(TITLE, DURATION, POSTER_FILENAME, TRAILER_URL, DESCRIPTION)
VALUES ('Movie One', 120, 'https://i.pinimg.com/originals/96/a0/0d/96a00d42b0ff8f80b7cdf2926a211e47.jpg', null, 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.');

INSERT INTO MOVIES(TITLE, DURATION, POSTER_FILENAME, TRAILER_URL, DESCRIPTION)
VALUES ('Harry Potter', 120, 'https://i.pinimg.com/originals/7d/54/25/7d542519fd44803af0f3a029f77c96f9.jpg', 'VyHV0BRtdxo', 'This is the tale of Harry Potter (Daniel Radcliffe), an ordinary eleven-year-old boy serving as a sort of slave for his aunt and uncle who learns that he is actually a wizard and has been invited to attend the Hogwarts School for Witchcraft and Wizardry.');

INSERT INTO MOVIES(TITLE, DURATION, POSTER_FILENAME, TRAILER_URL, DESCRIPTION)
VALUES ('Shrek', 90, 'https://i.pinimg.com/originals/2e/b3/f1/2eb3f12fb9e2d956c97be7afdab5865e.jpg', 'CwXOrWvPBPk', 'Shrek, a mean-spirited and highly territorial green ogre who loves the solitude of his swamp, finds his life interrupted when he is befriended by a talkative Donkey, one of countless fairytale creatures exiled to Shrek''s swamp by the fairytale-hating and vertically-challenged Lord Farquaad of Duloc. Angered by the intrusion, he decides to ask Farquaad to exile them elsewhere, bringing Donkey along as he is the only one willing to guide him to Duloc.');

INSERT INTO ROOMS VALUES (1, 50);
INSERT INTO ROOMS VALUES (2, 50);

INSERT INTO SEATS_ROWS VALUES ('A', 10, 1);
INSERT INTO SEATS_ROWS VALUES ('B', 10, 1);
INSERT INTO SEATS_ROWS VALUES ('C', 10, 1);
INSERT INTO SEATS_ROWS VALUES ('D', 10, 1);
INSERT INTO SEATS_ROWS VALUES ('E', 10, 1);
INSERT INTO SEATS_ROWS VALUES ('A', 5, 2);
INSERT INTO SEATS_ROWS VALUES ('B', 5, 2);
INSERT INTO SEATS_ROWS VALUES ('C', 5, 2);
INSERT INTO SEATS_ROWS VALUES ('D', 10, 2);
INSERT INTO SEATS_ROWS VALUES ('E', 10, 2);
INSERT INTO SEATS_ROWS VALUES ('F', 15, 2);

INSERT INTO SCREENINGS VALUES (1, '2020-06-03T20:20:00.000', '2020-06-03T22:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (2, '2020-06-03T15:20:00.000', '2020-06-03T17:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (3, '2020-06-03T20:20:00.000', '2020-06-03T22:20:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');

INSERT INTO SCREENINGS VALUES (4, '2020-06-04T20:20:00.000', '2020-06-04T22:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (5, '2020-06-04T15:20:00.000', '2020-06-04T17:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (6, '2020-06-04T20:20:00.000', '2020-06-04T22:20:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');

INSERT INTO SCREENINGS VALUES (7, '2020-06-07T20:20:00.000', '2020-06-07T22:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (8, '2020-06-07T15:20:00.000', '2020-06-07T17:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (9, '2020-06-07T20:20:00.000', '2020-06-07T22:20:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');

INSERT INTO SCREENINGS VALUES (10, '2020-06-10T20:20:00.000', '2020-06-10T22:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (11, '2020-06-10T15:20:00.000', '2020-06-10T17:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (12, '2020-06-10T20:20:00.000', '2020-06-10T22:20:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');

INSERT INTO SCREENINGS VALUES (13, '2020-06-14T20:20:00.000', '2020-06-14T22:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (14, '2020-06-14T15:20:00.000', '2020-06-14T17:20:00.000', 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (15, '2020-06-14T20:20:00.000', '2020-06-14T22:20:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');
INSERT INTO SCREENINGS VALUES (21, '2020-06-14T12:30:00.000', '2020-06-14T14:00:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');
INSERT INTO SCREENINGS VALUES (22, '2020-06-14T14:00:00.000', '2020-06-14T15:30:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');
INSERT INTO SCREENINGS VALUES (23, '2020-06-14T17:00:00.000', '2020-06-14T18:30:00.000', 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');

INSERT INTO SCREENINGS VALUES (16, CURRENT_DATE() + CAST('20:20:00.000' AS TIME), CURRENT_DATE() +CAST('22:20:00.000' AS TIME), 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (17, CURRENT_DATE() + CAST('15:20:00.000' AS TIME), CURRENT_DATE() + CAST('17:20:00.000' AS TIME), 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (18, CURRENT_DATE() + CAST('20:20:00.000' AS TIME), CURRENT_DATE() + CAST('22:20:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');
INSERT INTO SCREENINGS VALUES (24, CURRENT_DATE() + CAST('12:30:00.000' AS TIME), CURRENT_DATE() + CAST('14:00:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');
INSERT INTO SCREENINGS VALUES (25, CURRENT_DATE() + CAST('14:00:00.000' AS TIME), CURRENT_DATE() + CAST('15:30:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');
INSERT INTO SCREENINGS VALUES (26, CURRENT_DATE() + CAST('17:00:00.000' AS TIME), CURRENT_DATE() + CAST('18:30:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');

INSERT INTO SCREENINGS VALUES (19, CURRENT_DATE() + 1 + CAST('15:20:00.000' AS TIME), CURRENT_DATE() + 1 + CAST('17:20:00.000' AS TIME), 1, SELECT Id FROM MOVIES WHERE TITLE = 'Movie One');
INSERT INTO SCREENINGS VALUES (20, CURRENT_DATE() + 1 + CAST('20:20:00.000' AS TIME), CURRENT_DATE() + 1 + CAST('22:20:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Harry Potter');
INSERT INTO SCREENINGS VALUES (27, CURRENT_DATE() + 1 + CAST('12:30:00.000' AS TIME), CURRENT_DATE() + 1 + CAST('14:00:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');
INSERT INTO SCREENINGS VALUES (28, CURRENT_DATE() + 1 + CAST('14:00:00.000' AS TIME), CURRENT_DATE() + 1 + CAST('15:30:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');
INSERT INTO SCREENINGS VALUES (29, CURRENT_DATE() + 1 + CAST('17:00:00.000' AS TIME), CURRENT_DATE() + 1 + CAST('18:30:00.000' AS TIME), 2, SELECT Id FROM MOVIES WHERE TITLE = 'Shrek');

INSERT INTO TICKETS(SCREENING_ID, USER_ID) VALUES (14, 2);
INSERT INTO TICKETS(SCREENING_ID, USER_ID) VALUES (21, 2);
INSERT INTO TICKETS(SCREENING_ID, USER_ID) VALUES (17, 2);

INSERT INTO TICKET_MANAGED_TICKETS VALUES (SELECT ID FROM TICKETS WHERE SCREENING_ID = 14 AND USER_ID = 2, 2, 3);
INSERT INTO TICKET_MANAGED_TICKETS VALUES (SELECT ID FROM TICKETS WHERE SCREENING_ID = 21 AND USER_ID = 2, 2, 3);
INSERT INTO TICKET_MANAGED_TICKETS VALUES (SELECT ID FROM TICKETS WHERE SCREENING_ID = 17 AND USER_ID = 2, 2, 3);

INSERT INTO SEATS VALUES (1, 'A-1', SELECT ID FROM TICKETS WHERE SCREENING_ID = 14 AND USER_ID = 2);
INSERT INTO SEATS VALUES (2, 'A-2', SELECT ID FROM TICKETS WHERE SCREENING_ID = 14 AND USER_ID = 2);
INSERT INTO SEATS VALUES (3, 'A-3', SELECT ID FROM TICKETS WHERE SCREENING_ID = 14 AND USER_ID = 2);

INSERT INTO SEATS VALUES (4, 'A-1', SELECT ID FROM TICKETS WHERE SCREENING_ID = 21 AND USER_ID = 2);
INSERT INTO SEATS VALUES (5, 'A-2', SELECT ID FROM TICKETS WHERE SCREENING_ID = 21 AND USER_ID = 2);
INSERT INTO SEATS VALUES (6, 'A-3', SELECT ID FROM TICKETS WHERE SCREENING_ID = 21 AND USER_ID = 2);

INSERT INTO SEATS VALUES (7, 'A-1', SELECT ID FROM TICKETS WHERE SCREENING_ID = 17 AND USER_ID = 2);
INSERT INTO SEATS VALUES (8, 'A-2', SELECT ID FROM TICKETS WHERE SCREENING_ID = 17 AND USER_ID = 2);
INSERT INTO SEATS VALUES (9, 'A-3', SELECT ID FROM TICKETS WHERE SCREENING_ID = 17 AND USER_ID = 2);